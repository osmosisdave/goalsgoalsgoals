<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Goals Goals Goals</title>
  <link rel="stylesheet" href="assets/css/styles.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
</head>
<body>
  <nav>
    <div class="nav-wrapper blue darken-2">
      <div class="container">
        <a href="index.html" class="brand-logo">
          Goals Goals Goals
        </a>
        <a href="#" data-target="mobile-nav" class="sidenav-trigger right"><i class="material-icons">menu</i></a>
        <ul id="nav-desktop" class="right hide-on-med-and-down">
          <li><a href="index.html">Home</a></li>
          <li><a href="leagues.html">Leagues</a></li>
          <li><a href="matches.html">Matches</a></li>
          <li id="nav-login-link"><a href="login.html">Login</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <ul class="sidenav" id="mobile-nav">
    <li><a href="index.html">Home</a></li>
    <li><a href="leagues.html">Leagues</a></li>
    <li><a href="matches.html">Matches</a></li>
    <li id="nav-login-link-mobile"><a href="login.html">Login</a></li>
  </ul>

  <main class="container section">
    <div class="row">
      <div class="col s12">
        <h4>Admin Dashboard</h4>
        <p id="adminWelcome"></p>
        
        <!-- Sync Fixtures from API Card -->
        <div class="card">
          <div class="card-content">
            <span class="card-title">Sync Fixtures from API-Football</span>
            <p>Fetch latest fixtures from API-Football and save to database</p>
            <div id="syncStatus" style="margin-top: 15px;"></div>
          </div>
          <div class="card-action">
            <a href="#" id="syncFixturesBtn" class="btn waves-effect waves-light blue">
              <i class="material-icons left">sync</i>Sync Fixtures
            </a>
            <span id="syncProgress" style="margin-left: 15px; display: none;">
              <div class="preloader-wrapper small active">
                <div class="spinner-layer spinner-blue-only">
                  <div class="circle-clipper left">
                    <div class="circle"></div>
                  </div>
                  <div class="gap-patch">
                    <div class="circle"></div>
                  </div>
                  <div class="circle-clipper right">
                    <div class="circle"></div>
                  </div>
                </div>
              </div>
              <span id="syncProgressText" style="margin-left: 10px;">Syncing...</span>
            </span>
          </div>
        </div>

        <!-- Match Selection History Card -->
        <div class="card">
          <div class="card-content">
            <span class="card-title">Match Selection History</span>
            <p>View archived match selections from finished games</p>
          </div>
          <div class="card-action">
            <a href="#" id="viewHistoryBtn" class="btn waves-effect waves-light">
              <i class="material-icons left">history</i>View History
            </a>
            <a href="#" id="archiveNowBtn" class="btn waves-effect waves-light orange">
              <i class="material-icons left">archive</i>Archive Finished Matches Now
            </a>
          </div>
        </div>

        <h5>Static Users</h5>
        <ul id="userList" class="collection"></ul>

        <h5>Create User</h5>
        <form id="createUserForm" class="row">
          <div class="input-field col s12 m4">
            <input id="newUsername" type="text" required>
            <label for="newUsername">Username</label>
          </div>
          <div class="input-field col s12 m4">
            <input id="newPassword" type="password" required>
            <label for="newPassword">Password</label>
          </div>
          <div class="input-field col s12 m4">
            <input id="newRole" type="text" value="user">
            <label for="newRole">Role</label>
          </div>
          <div class="col s12">
            <button class="btn waves-effect waves-light" type="submit">Create user</button>
            <span id="createUserMsg" class="" style="margin-left:1rem"></span>
          </div>
        </form>
      </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal modal-fixed-footer" style="max-height: 90%;">
      <div class="modal-content">
        <h4>Match Selection History</h4>
        <div class="row">
          <div class="col s12 m6">
            <div class="input-field">
              <input id="filterUsername" type="text" placeholder="Filter by username">
              <label for="filterUsername">Username Filter</label>
            </div>
          </div>
          <div class="col s12 m6">
            <p style="margin-top: 20px;">
              Total archived selections: <strong id="historyCount">0</strong>
            </p>
          </div>
        </div>
        <div id="historyContent">
          <div class="progress">
            <div class="indeterminate"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
      </div>
    </div>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script src="assets/js/config.js"></script>
  <script src="assets/js/site-header.js"></script>
  <script type="module" src="assets/js/auth.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize modals
      const modals = document.querySelectorAll('.modal');
      M.Modal.init(modals);

      // Sync Fixtures button
      document.getElementById('syncFixturesBtn').addEventListener('click', async function(e) {
        e.preventDefault();
        
        const token = localStorage.getItem('token');
        if (!token) {
          M.toast({html: 'Not authenticated', classes: 'red'});
          return;
        }

        // Disable button and show progress
        const syncBtn = document.getElementById('syncFixturesBtn');
        const syncProgress = document.getElementById('syncProgress');
        const syncStatus = document.getElementById('syncStatus');
        
        syncBtn.classList.add('disabled');
        syncProgress.style.display = 'inline-block';
        syncStatus.innerHTML = '<p class="blue-text">Starting sync...</p>';

        try {
          const response = await fetch(`${API_BASE_URL}/api/admin/sync-fixtures`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              season: 2025,
              dateRange: 20
            })
          });

          const data = await response.json();

          if (response.ok) {
            syncStatus.innerHTML = `
              <div class="card-panel green lighten-4 green-text text-darken-4">
                <h6><i class="material-icons left">check_circle</i>Sync Complete!</h6>
                <ul>
                  <li><strong>Total Fixtures:</strong> ${data.summary.totalFixtures}</li>
                  <li><strong>New:</strong> ${data.summary.newFixtures}</li>
                  <li><strong>Updated:</strong> ${data.summary.updatedFixtures}</li>
                  <li><strong>Leagues Synced:</strong> ${data.summary.leaguesSynced}</li>
                  <li><strong>API Calls Used:</strong> ${data.summary.apiCallsUsed}</li>
                  <li><strong>Duration:</strong> ${(data.summary.duration / 1000).toFixed(2)}s</li>
                </ul>
                ${data.details && data.details.length > 0 ? `
                  <p style="margin-top: 10px;"><strong>Details:</strong></p>
                  <ul>${data.details.map(d => `<li>${d}</li>`).join('')}</ul>
                ` : ''}
              </div>
            `;
            M.toast({html: `✓ Synced ${data.summary.totalFixtures} fixtures!`, classes: 'green'});
          } else {
            throw new Error(data.error || 'Sync failed');
          }
        } catch (error) {
          console.error('Sync error:', error);
          syncStatus.innerHTML = `
            <div class="card-panel red lighten-4 red-text text-darken-4">
              <i class="material-icons left">error</i>
              <strong>Sync Failed:</strong> ${error.message}
            </div>
          `;
          M.toast({html: `✗ Sync failed: ${error.message}`, classes: 'red'});
        } finally {
          syncBtn.classList.remove('disabled');
          syncProgress.style.display = 'none';
        }
      });

      // View History button
      document.getElementById('viewHistoryBtn').addEventListener('click', async function(e) {
        e.preventDefault();
        const modal = M.Modal.getInstance(document.getElementById('historyModal'));
        modal.open();
        await loadHistory();
      });

      // Archive Now button
      document.getElementById('archiveNowBtn').addEventListener('click', async function(e) {
        e.preventDefault();
        if (confirm('Archive all finished match selections now?')) {
          try {
            const response = await fetch(`${API_BASE_URL}/api/matches/archive-finished`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            });
            
            const data = await response.json();
            if (data.success) {
              M.toast({html: data.message, classes: 'green'});
            } else {
              M.toast({html: 'Failed to archive', classes: 'red'});
            }
          } catch (error) {
            console.error('Archive error:', error);
            M.toast({html: 'Error archiving matches', classes: 'red'});
          }
        }
      });

      // Filter username
      let allHistory = [];
      document.getElementById('filterUsername').addEventListener('input', function(e) {
        const filterText = e.target.value.toLowerCase();
        if (filterText === '') {
          displayHistory(allHistory);
        } else {
          const filtered = allHistory.filter(h => h.username.toLowerCase().includes(filterText));
          displayHistory(filtered);
        }
      });

      async function loadHistory() {
        const content = document.getElementById('historyContent');
        content.innerHTML = '<div class="progress"><div class="indeterminate"></div></div>';
        
        try {
          const response = await fetch(`${API_BASE_URL}/api/matches/history`);
          const data = await response.json();
          
          if (data.success) {
            allHistory = data.history;
            document.getElementById('historyCount').textContent = data.count;
            displayHistory(allHistory);
          } else {
            content.innerHTML = '<p class="red-text">Failed to load history</p>';
          }
        } catch (error) {
          console.error('Load history error:', error);
          content.innerHTML = '<p class="red-text">Error loading history</p>';
        }
      }

      function displayHistory(history) {
        const content = document.getElementById('historyContent');
        
        if (history.length === 0) {
          content.innerHTML = '<p class="grey-text">No archived match selections found</p>';
          return;
        }

        let html = '<table class="striped highlight responsive-table"><thead><tr>' +
          '<th>User</th><th>Match</th><th>Score</th><th>Round</th><th>League</th><th>Selected</th><th>Archived</th>' +
          '</tr></thead><tbody>';
        
        history.forEach(h => {
          const selectedDate = new Date(h.selectedAt).toLocaleDateString();
          const archivedDate = new Date(h.archivedAt).toLocaleString();
          html += `<tr>
            <td><strong>${h.username}</strong></td>
            <td>${h.homeTeam} vs ${h.awayTeam}</td>
            <td><span class="badge">${h.finalScore.home} - ${h.finalScore.away}</span></td>
            <td>${h.round || 'N/A'}</td>
            <td>${h.leagueName || 'N/A'}</td>
            <td>${selectedDate}</td>
            <td>${archivedDate}</td>
          </tr>`;
        });
        
        html += '</tbody></table>';
        content.innerHTML = html;
      }
    });
  </script>
</body>
</html>
